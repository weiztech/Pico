{% extends 'base_lit_reviews.html' %}
{% load static %}
{% block 'head' %}
<link href="{% static 'css/theme/adverse_events.css' %}" rel="stylesheet" type="text/css" />
{% endblock %}

{% block 'help_section' %}
<a href="https://citemed-io.gitbook.io/citemed.io-documentation/advanced-topics/adverse-event-review" target="_blank">
  <span>Need help with this page? <br /> Read the Wiki</span>
  <div>
    <img src="{% static 'images/icons/wiki-icon.svg' %}">
  </div>
</a>
{% endblock %}

{% block 'body' %}
<div class="form-content" id="ae-list">
  <div class="section-header mb">
    <div class="center-v w-100">
        {% if page_switcher == "events" %}
          Adverse Events 
        {% else %}
          Recalls
        {% endif %}
         ({{total_count}})
        <div class="tooltip right-tooltip" title="Adverse Events / Recalls List Please use the switcher on the right to switch between the list of the two">
          <img src="{% static 'images/icons/tooltip.svg' %}" alt="" srcset="">
        </div>
        <page-wiki-helper wiki-link="https://citemed-io.gitbook.io/citemed.io-documentation/advanced-topics/adverse-event-review"> </page-wiki-helper>
    </div>

    <div class="ml-auto">
      <div class="switcher ae-switcher">
        {% if page_switcher == "events" %}
        <a class="switch-item active" id="ae-switcher">
          Adverse Events
        </a>
        {% else %}
        <a class="switch-item" id="ae-switcher">
          Adverse Events
        </a>
        {% endif %}

        {% if page_switcher == "recalls" %}
        <a class="switch-item active" id="recalls-switcher">
          Recalls
        </a>
        {% else %}
        <a class="switch-item" id="recalls-switcher">
          Recalls
        </a>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="horizantal-devider mt-2 mb-2"></div>

  {% if page_switcher == "events" %}

    <div class="filters">
      <div class="search-section">
        <form id="search-form">
          <input type="text" placeholder="Search For Results by Description, Manufacturer ...etc" name="search_term"
            id="search_term" value="{{search_term}}" />

          <button type="submit" class="search-button">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd" clip-rule="evenodd"
                d="M9.0625 3.125C5.78331 3.125 3.125 5.78331 3.125 9.0625C3.125 12.3417 5.78331 15 9.0625 15C12.3417 15 15 12.3417 15 9.0625C15 5.78331 12.3417 3.125 9.0625 3.125ZM1.875 9.0625C1.875 5.09295 5.09295 1.875 9.0625 1.875C13.032 1.875 16.25 5.09295 16.25 9.0625C16.25 13.032 13.032 16.25 9.0625 16.25C5.09295 16.25 1.875 13.032 1.875 9.0625Z"
                fill="#9BA5B9" />
              <path fill-rule="evenodd" clip-rule="evenodd"
                d="M13.2611 13.2612C13.5051 13.0171 13.9009 13.0171 14.1449 13.2612L17.9418 17.0581C18.1859 17.3022 18.1859 17.6979 17.9418 17.942C17.6977 18.1861 17.302 18.1861 17.0579 17.942L13.2611 14.1451C13.017 13.901 13.017 13.5053 13.2611 13.2612Z"
                fill="#9BA5B9" />
            </svg>
          </button>
        </form>
      </div>

      <!-- Filters -->
      <div class="filter-button ml" v-on:click="showModal('filter-slider')">
        {% if current_event_types or search_term or current_manufacturer_filter or current_brand_name_filter or current_state_filter %}
        <div class="filter-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path
              d="M3.6 1.40002H12.4C13.1333 1.40002 13.7333 2.00002 13.7333 2.73336V4.20002C13.7333 4.73336 13.4 5.40002 13.0667 5.73336L10.2 8.26669C9.8 8.60002 9.53333 9.26669 9.53333 9.80002V12.6667C9.53333 13.0667 9.26666 13.6 8.93333 13.8L8 14.4C7.13333 14.9334 5.93333 14.3334 5.93333 13.2667V9.73336C5.93333 9.26669 5.66666 8.66669 5.4 8.33336L2.86666 5.66669C2.53333 5.33336 2.26666 4.73336 2.26666 4.33336V2.80002C2.26666 2.00002 2.86666 1.40002 3.6 1.40002Z"
              stroke="#292D32" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
          <svg class="filter-applied" xmlns="http://www.w3.org/2000/svg" width="6" height="6" viewBox="0 0 6 6"
            fill="none">
            <circle cx="3" cy="3" r="2.5" fill="#F7154B" stroke="white" />
          </svg>
        </div>
        {% else %}
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
          <path
            d="M3.6 1.4H12.4C13.1333 1.4 13.7333 2 13.7333 2.73333V4.2C13.7333 4.73334 13.4 5.4 13.0667 5.73334L10.2 8.26667C9.8 8.6 9.53333 9.26667 9.53333 9.8V12.6667C9.53333 13.0667 9.26666 13.6 8.93333 13.8L8 14.4C7.13333 14.9333 5.93333 14.3333 5.93333 13.2667V9.73334C5.93333 9.26667 5.66666 8.66667 5.4 8.33333L2.86666 5.66667C2.53333 5.33334 2.26666 4.73334 2.26666 4.33334V2.8C2.26666 2 2.86666 1.4 3.6 1.4Z"
            stroke="#292D32" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
        {% endif %}
        Filter Results
      </div>

      <div class="slider" id="filter-slider">
        <form>
          <div class="slider-dialog">
            <div class="slider-dialog-inner ">
              <div class="slider-header">
                <button class="pagintaion-item mr" v-on:click="hideModal('filter-slider')" type="button">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10.0002 13.28L5.65355 8.93333C5.14022 8.42 5.14022 7.58 5.65355 7.06667L10.0002 2.72"
                      stroke="#292D32" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round"
                      stroke-linejoin="round" />
                  </svg>
                </button>
                Filters
              </div>

              <div class="slider-content">
                <div class="filter-section">
                  <div class="header"> Event Type </div>
                  <div class="filter-checks">
                    <div class="filter-check">
                      <label for="death">
                        Death ({{death_count}})
                      </label>
                      <input type="checkbox" name="event-type" value="Death" id="death" {% if 'Death' in current_event_types %} checked {% endif %} />
                    </div>

                    <div class="filter-check">
                      <label for="Injury">
                        Injury ({{injury_count}})
                      </label>
                      <input type="checkbox" name="event-type" value="Injury" id="Injury" {% if 'Injury' in current_event_types %} checked {% endif %} />
                    </div>


                    <div class="filter-check">
                      <label for="Malfunction">
                        Malfunction ({{malfunction_count}})
                      </label>
                      <input type="checkbox" name="event-type" value="Malfunction" id="Malfunction" {% if 'Malfunction' in current_event_types %} checked {% endif %} />
                    </div>


                    <div class="filter-check">
                      <label for="Other">
                        Other ({{other_count}})
                      </label>
                      <input type="checkbox" name="event-type" value="Other" id="Other" {% if 'Other' in current_event_types %} checked {% endif %} />
                    </div>

                  </div>
                </div>

                <div class="horizantal-devider mt-2 mb-2"></div>

                <div class="slider-section">
                  <div class="modal-body">
                    <div class="form-group">
                      <label for="exampleFormControlSelect1">Manufacturer</label>
                      <select class="form-control" id="exampleFormControlSelect1" name="manufacturer">
                        <option value=""> Select Manufacturer </option>
                        {% for manufacturer in manufacturer_list %}
                        {% if current_manufacturer_filter == manufacturer %}
                        <option value="{{manufacturer}}" selected="selected"> {{manufacturer}} </option>
                        {% else %}
                        <option value="{{manufacturer}}"> {{manufacturer}} </option>
                        {% endif %}
                        {% endfor %}
                      </select>
                    </div>
                    <div class="form-group">
                      <label for="exampleFormControlSelect1">Brand Name</label>
                      <select class="form-control" id="exampleFormControlSelect1" name="brand_name">
                        <option value=""> Select Brand Name </option>
                        {% for brand_name in brand_name_list %}
                        {% if current_brand_name_filter == brand_name %}
                        <option value="{{brand_name}}" selected="selected"> {{brand_name}} </option>
                        {% else %}
                        <option value="{{brand_name}}"> {{brand_name}} </option>
                        {% endif %}
                        {% endfor %}
                      </select>
                    </div>
                    <div class="form-group" style="padding-bottom: 50px;">
                      <label for="stateSelect">Review State                          
                        <span style="height: 17px;" class="right-tooltip" title="This is the current review <br/> status of the event, <br/>by default all imported Maude<br/> events are 'Not Reviewed' "> 
                          <img src="{% static 'images/icons/tooltip.svg' %}" alt="" srcset="">
                        </span>
                      </label>
                      <select class="form-control" id="stateSelect" name="state">
                        <option value=""> Select a state </option>
                        {% if current_state_filter == "IN" %}
                        <option value="IN" selected="selected"> Included</option>
                        {% else %}
                        <option value="IN"> Included</option>
                        {% endif %}

                        {% if current_state_filter == "SM" %}
                        <option value="SM" selected="selected"> Similar</option>
                        {% else %}
                        <option value="SM"> Similar</option>
                        {% endif %}

                        {% if current_state_filter == "EX" %}
                        <option value="EX" selected="selected"> Excluded or not Relevant </option>
                        {% else %}
                        <option value="EX"> Excluded or not Relevant </option>
                        {% endif %}

                        {% if current_state_filter == "UN" %}
                        <option value="UN" selected="selected"> Not Reviewed </option>
                        {% else %}
                        <option value="UN"> Not Reviewed </option>
                        {% endif %}

                        {% if current_state_filter == "DU" %}
                        <option value="DU" selected="selected"> Duplicate </option>
                        {% else %}
                        <option value="DU"> Duplicate </option>
                        {% endif %}
                      </select>
                    </div>
                  </div>

                </div>
              </div>

              <div class="slider-footer">
                <input type="submit" value="Filter Results" id="filter-submit" class="primary-button">
              </div>

            </div>
          </div>
        </form>
      </div>


      {% if current_event_types or search_term or current_manufacturer_filter or current_brand_name_filter or current_state_filter %}
      <a class="filter-button ml" href="?sorting={{current_sorting}}&page_switcher={{page_switcher}}">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M14 3.98665C11.78 3.76665 9.54667 3.65332 7.32 3.65332C6 3.65332 4.68 3.71999 3.36 3.85332L2 3.98665"
            stroke="#292D32" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
          <path
            d="M5.6665 3.31331L5.81317 2.43998C5.91984 1.80665 5.99984 1.33331 7.1265 1.33331H8.87317C9.99984 1.33331 10.0865 1.83331 10.1865 2.44665L10.3332 3.31331"
            stroke="#292D32" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
          <path
            d="M12.5664 6.09332L12.1331 12.8067C12.0598 13.8533 11.9998 14.6667 10.1398 14.6667H5.85977C3.99977 14.6667 3.93977 13.8533 3.86644 12.8067L3.43311 6.09332"
            stroke="#292D32" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
          <path d="M6.88672 11H9.10672" stroke="#292D32" stroke-width="1.5" stroke-linecap="round"
            stroke-linejoin="round" />
          <path d="M6.3335 8.33331H9.66683" stroke="#292D32" stroke-width="1.5" stroke-linecap="round"
            stroke-linejoin="round" />
        </svg>
        Clear All
      </a>
      {% endif %}

    </div>

  {% endif %}
  
  
  <!-- Filter for recalls-->
  {% if page_switcher == "recalls" %}

    <div class="filters">
      <div class="search-section">
        <form id="search-form">
          <input type="hidden"  name="page_switcher"
          id="search_recall" value="{{page_switcher}}" />
          <input type="text" placeholder="Search For Recalls" name="search_recall"
            id="search_recall" value="{{search_recall}}" />

          <button type="submit" class="search-button">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd" clip-rule="evenodd"
                d="M9.0625 3.125C5.78331 3.125 3.125 5.78331 3.125 9.0625C3.125 12.3417 5.78331 15 9.0625 15C12.3417 15 15 12.3417 15 9.0625C15 5.78331 12.3417 3.125 9.0625 3.125ZM1.875 9.0625C1.875 5.09295 5.09295 1.875 9.0625 1.875C13.032 1.875 16.25 5.09295 16.25 9.0625C16.25 13.032 13.032 16.25 9.0625 16.25C5.09295 16.25 1.875 13.032 1.875 9.0625Z"
                fill="#9BA5B9" />
              <path fill-rule="evenodd" clip-rule="evenodd"
                d="M13.2611 13.2612C13.5051 13.0171 13.9009 13.0171 14.1449 13.2612L17.9418 17.0581C18.1859 17.3022 18.1859 17.6979 17.9418 17.942C17.6977 18.1861 17.302 18.1861 17.0579 17.942L13.2611 14.1451C13.017 13.901 13.017 13.5053 13.2611 13.2612Z"
                fill="#9BA5B9" />
            </svg>
          </button>
        </form>
      </div>

     


      {% if search_recall %}
      <a class="filter-button ml" href="?sorting={{current_sorting}}&page_switcher={{page_switcher}}">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M14 3.98665C11.78 3.76665 9.54667 3.65332 7.32 3.65332C6 3.65332 4.68 3.71999 3.36 3.85332L2 3.98665"
            stroke="#292D32" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
          <path
            d="M5.6665 3.31331L5.81317 2.43998C5.91984 1.80665 5.99984 1.33331 7.1265 1.33331H8.87317C9.99984 1.33331 10.0865 1.83331 10.1865 2.44665L10.3332 3.31331"
            stroke="#292D32" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
          <path
            d="M12.5664 6.09332L12.1331 12.8067C12.0598 13.8533 11.9998 14.6667 10.1398 14.6667H5.85977C3.99977 14.6667 3.93977 13.8533 3.86644 12.8067L3.43311 6.09332"
            stroke="#292D32" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
          <path d="M6.88672 11H9.10672" stroke="#292D32" stroke-width="1.5" stroke-linecap="round"
            stroke-linejoin="round" />
          <path d="M6.3335 8.33331H9.66683" stroke="#292D32" stroke-width="1.5" stroke-linecap="round"
            stroke-linejoin="round" />
        </svg>
        Clear Search
      </a>
      {% endif %}

    </div>

  {% endif %}
  <div class="tabs">
    <div class="switch-section-tabs">
          {% if page_switcher == "events" %}
            {% if events %}
              <table id="table" class="custom-table">
                <thead>
                  <tr>
                    <th style="width: 35px;">
                      <input id="checkAllEvents" type="checkbox" name="check-article" ref="checkAllEvents"  />
                    </th>
                    <th style="width: 70px;"> ID </th>
                    <th style="width: 200px;"> Details </th>
                    <th style="width: 100px;" id="type_sorting">
                      Type <img src="{% static 'images/icons/filter.png' %}" />
                    </th>

                    <th style="width: 300px;">Description</th>
                    <th style="width: 120px;">State </th>
                    <th style="width: 150px;" id="manufacturer-sorting">
                      Manufacturer <img src="{% static 'images/icons/filter.png' %}" />
                    </th>
                    <th style="width: 120px;">Brand Name </th>
                  </tr>
                </thead>
                <tbody>
                  {% for event in events %}
                  <tr>
                    <td class="events-checbox-input"> 
                      <input type="checkbox" name="check-article" value="{{ event.id}}" class="" /> 
                    </td>
                    <td> #{{ event.id }} </td>
                    <td>
                      <div>
                        <strong>
                          <a href="/literature_reviews/{{literature_review_id}}/adverse_event_review/{{event.id}}?{{pagination_params}}"
                            class="link">
                            Review Details Page
                          </a>
                        </strong>
                      </div>

                      <div>
                        <strong>
                          <a href="{{ event.ae.event_uid }}" class="link"> Event Link </a>
                        </strong>
                      </div>

                      <div>
                        <strong> Event Date </strong>
                        {{ event.ae.event_date }}
                      </div>

                      <div>
                        <strong> Report Date </strong>
                        {{ event.ae.report_date }}
                      </div>
                    </td>

                    <td> {{ event.ae.event_type }} </td>
                    <td>
                      <div class="event-desc" title="{{  event.ae.description }}">
                        {{ event.ae.description|make_list|slice:':200'|join:'' }}...
                      </div>
                    </td>

                    <td>
                      <div {% if event.state == 'IN' %} class="badge badge success" {% else %} class="badge secondary" {% endif %}>
                        {{ event.get_state_display }}
                      </div>
                      {% if event.state != 'IN' %}        
                        {% if is_archived %}
                          <a class="primary-button mt w-100 include-ae disabled" disabled="disabled" ae-id="{{event.id}}" ae-type="ae">
                            Include AE
                          </a>
                        {% else %}
                          <a class="primary-button mt w-100 include-ae" ae-id="{{event.id}}" ae-type="ae">
                            Include AE
                          </a>
                        {% endif %}
                      {% endif %}
                    </td>
                    <td>
                      {{ event.ae.manufacturer }}
                    </td>
                    <td>
                      {{ event.ae.brand_name }}
                    </td>

                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            
              {% if events_paginator %}
                <div class="table-footer">
                  <div class="left-section"> </div>
                  <div class="middle-section">
                    <div class="pagination">
                      {% if events_paginator.has_previous %}
                        <a 
                          class="pagintaion-item" 
                          href="?events_page={{ events_paginator.previous_page_number }}{{pagination_params}}"
                        >
                          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10.0002 13.28L5.65355 8.93333C5.14022 8.42 5.14022 7.58 5.65355 7.06667L10.0002 2.72"
                              stroke="#292D32" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round"
                              stroke-linejoin="round" />
                          </svg>
                        </a>
                      {% endif %}

                      {% for num in events_paginator.paginator.page_range %}
                        {% if events_paginator.number == num %}
                          <a class="pagintaion-item selected" href="?events_page={{ num }}{{pagination_params}}">
                            {{ num }}
                          </a>
                        {% elif num > events_paginator.number|add:'-3' and num < events_paginator.number|add:'3' %} 
                          <a class="pagintaion-item" href="?events_page={{ num }}{{pagination_params}}">
                            {{ num }}
                          </a>
                        {% endif %}
                      {% endfor %}

                      {% if events_paginator.has_next %}
                        <a 
                          class="pagintaion-item"
                          href="?events_page={{ events_paginator.next_page_number }}{{pagination_params}}"
                        >
                          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M5.93994 13.28L10.2866 8.93333C10.7999 8.42 10.7999 7.58 10.2866 7.06667L5.93994 2.72"
                              stroke="#292D32" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round"
                              stroke-linejoin="round" />
                          </svg>
                        </a>
                      {% endif %}
                    </div>
                  </div>
                  <div class="right-section">
                    {{current_page_pagination_details}}
                  </div>
                </div>
              {% endif %}
            {% else %}
              <div class="no-event-recall-section">
                <p class="no-event-recall-section-text">No Adverse Events Available. </p>
              </div>
            {% endif %}

          {% elif page_switcher == "recalls" %}
              {% if recalls %}
                <table class="custom-table">
                  <thead>
                    <tr>
                      <th>ID </th>
                      <th>Name</th>

                      <th>Recall Type </th>
                      <th>Description</th>
                      <th>State </th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for recall in recalls %}
                    <tr>
                      <td>{{ recall.ae.event_uid }}</td>
                      <td> {{ recall.ae.firm_name }} - {{ recall.ae.trade_name }} </td>


                      <td> {{ recall.ae.recall_class }}</td>

                      <td>{{ recall.ae.recall_reason }}</td>

                      <td>
                        <div {% if recall.state == 'IN' %} class="badge badge success" {% else %} class="badge secondary" {% endif %}>
                          {{ recall.get_state_display }}
                        </div>

                        {% if recall.state != 'IN' %}
                          {% if is_archived %}
                            <a class="primary-button mt w-100 include-ae disabled" ae-id="{{recall.id}}" disabled="disabled" ae-type="recall">
                              Include Recall
                            </a>
                          {% else %}
                            <a class="primary-button mt w-100 include-ae" ae-id="{{recall.id}}" ae-type="recall">
                              Include Recall
                            </a>
                          {% endif %}
                        {% endif %}
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>

                {% if recalls_paginator %}
                  <div class="table-footer">
                    <div class="left-section"> </div>
                    <div class="middle-section">
                      <div class="pagination">
                        {% if recalls_paginator.has_previous %}
                          <a 
                            class="pagintaion-item"
                            href="?recalls_page={{ recalls_paginator.previous_page_number }}{{pagination_params}}"
                          >
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                              <path d="M10.0002 13.28L5.65355 8.93333C5.14022 8.42 5.14022 7.58 5.65355 7.06667L10.0002 2.72"
                                stroke="#292D32" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round"
                                stroke-linejoin="round" />
                            </svg>
                          </a>
                        {% endif %}

                        {% for num in recalls_paginator.paginator.page_range %}
                          {% if recalls_paginator.number == num %}
                            <a class="pagintaion-item selected" href="?recalls_page={{ num }}{{pagination_params}}">
                              {{ num }}
                            </a>
                          {% elif num > recalls_paginator.number|add:'-3' and num < recalls_paginator.number|add:'3' %} 
                            <a
                              class="pagintaion-item" 
                              href="?recalls_page={{ num }}{{pagination_params}}"
                            >
                              {{ num }}
                            </a>
                          {% endif %}
                        {% endfor %}

                        {% if recalls_paginator.has_next %}
                          <a 
                            class="pagintaion-item"
                            href="?recalls_page={{ recalls_paginator.next_page_number }}{{pagination_params}}"
                          >
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                              <path d="M5.93994 13.28L10.2866 8.93333C10.7999 8.42 10.7999 7.58 10.2866 7.06667L5.93994 2.72"
                                stroke="#292D32" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round"
                                stroke-linejoin="round" />
                            </svg>
                          </a>
                        {% endif %}
                      </div>
                    </div>
                    <div class="right-section">
                      {{current_page_pagination_details}}
                    </div>
                  </div>
                {% endif %}

              {% else %}
                <div class="no-event-recall-section">
                  <p class="no-event-recall-section-text">No Recalls Available.</p>
                </div>
              {% endif %}
            {% endif %}
        </div>
      </div>
    </div>

    <form method="POST" class="floated-actions"  style="visibility: hidden;">
      {% csrf_token %}
      <div class="quantity" id="count-item-selected">
        04 Selected
      </div>
      <input type="hidden" name="eventsBulk[]" value="[]" id="selectedEvents" />
      <div class="bulk-state-dropdown" style="width: 300px;">        
        <select name="state">
          <option value="IN">Included</option>
          <option value="SM">Similar</option>
          <option value="EX">Excluded or not Relevant</option>
          <option value="UN">Not Reviewed</option>
          <option value="DU">Duplicate</option>        
        </select>       
      </div>
      {% if is_archived %}
          <button type="submit" class="primary-button" class="disabled" disabled="disabled">
            Apply
          </button>
      {% else %}
        <button type="submit" class="primary-button" :class="{ loading: isBulkUpdateLoading }" :disabled="isBulkUpdateLoading">
          Apply
        </button>
      {% endif %}
  </form>

    {% endblock %}

    {% block 'scripts-block' %}
    <script type="application/javascript" src="{% static 'lit_reviews/vue/adverse_events.js' %}"> </script>
    <script type="text/javascript">
      let URLParams = [];

      "{% if request.GET %}"
        "{% for key, values in request.GET.lists %}"
            "{% for value in values %}"
              URLParams.push({
                key: "{{ key }}",
                value: "{{ value }}",
              });
            "{% endfor %}"
        "{% endfor %}"
      "{% endif %}"      
      


      constructURL = function(extraParamKey, extraParamValue){
        let URL = "";
        const index = URLParams.findIndex(obj => obj.key === extraParamKey);
        if (index > -1)
          URLParams.splice(index, 1, {key: extraParamKey, value: extraParamValue});
        else
          URLParams.push({key: extraParamKey, value: extraParamValue})

        for (let param of URLParams) {
          if (URL.includes("?")) {
            URL = URL + `&${param.key}=${param.value}`;
          } else {
            URL = URL + `?${param.key}=${param.value}`;
          }
        }

        return URL;
      }

      const manufacturerSorting = document.getElementById("manufacturer-sorting");
        if (manufacturerSorting){
          manufacturerSorting.addEventListener("click", function(){
          const currentSorting = "{{current_sorting}}";
          if (currentSorting === "ae__manufacturer") { 
            window.location.href = constructURL("sorting", "-ae__manufacturer");
          } else {
            window.location.href = constructURL("sorting", "ae__manufacturer");
          }
        });
      }

      const typeSorting = document.getElementById("type_sorting");

      if (typeSorting) {
        typeSorting.addEventListener("click", function(){
          const currentSorting = "{{current_sorting}}";
          if (currentSorting === "ae__event_type") { 
            window.location.href = constructURL("sorting", "-ae__event_type");
          } else {
            window.location.href = constructURL("sorting", "ae__event_type");
          }
        });
      }

      const searchFrom = document.getElementById("search-form");
      if (searchFrom){
        searchFrom.addEventListener("submit", function(){
          const searchTerm = document.getElementById("search_term").value;
          window.location.href = constructURL("search_term");
        });
      }

      // Switch to Adverse Events Page
      document.getElementById("ae-switcher").addEventListener("click", function (e) {
        window.location.href = "?page_switcher=events";
      });

      // Switch to Recalls Page
      document.getElementById("recalls-switcher").addEventListener("click", function (e){
        window.location.href = "?page_switcher=recalls";
      });

      // On Include Adverse Event 
      includeBTNs = document.getElementsByClassName("include-ae");
      for (let i=0; i<includeBTNs.length; i++) {
        const BTN = includeBTNs[i];
        BTN.addEventListener("click", function(e){
          e.preventDefault();
          postData = new FormData();
          postData.append("ae_review_id", e.target.getAttribute("ae-id"));
          postData.append("ae_review_state", "IN");
          postData.append("type", e.target.getAttribute("ae-type"));
          axios.post("{% url 'literature_reviews:single_ae_review' %}", data=postData)
          .then(
            res => location.reload(),
            err => {
              console.log(err);
            }
          )
        }) 
      };
    
    var formSelect = document.querySelector('.floated-actions')
    var evensCheckbox = document.querySelectorAll('.events-checbox-input input')
    var quantity = document.querySelector('.quantity')
    var checkAllEvents = document.querySelector('#checkAllEvents')
    var selectedEventsValues = document.querySelector('#selectedEvents')
    var quantityText = "<span> Selected </span>"
    let listEventsSelected = []

    evensCheckbox.forEach(input => {

      checkAllEvents.addEventListener('click', ()=> {
        
          if(checkAllEvents.checked){
              input.checked = true
          }
          else{
              input.checked = false
          }
          
          if(input.checked){
            listEventsSelected.push(input.value)
          }
          else{
            listEventsSelected = listEventsSelected.filter(val => val !== input.value)
          }
          
          listEventsSelected = [...new Set(listEventsSelected)] 
          selectedEventsValues.value = listEventsSelected
          
          if(listEventsSelected.length > 0){
            formSelect.style.visibility = "visible"
          }else{
            formSelect.style.visibility = "hidden"
          }
          quantity.innerHTML = listEventsSelected.length + quantityText
      })
      
      input.addEventListener('click', ()=> {
        
        if(input.checked){
          listEventsSelected.push(input.value)
        }
        else{
          listEventsSelected = listEventsSelected.filter(val => val !== input.value)
          checkAllEvents.checked = false
        }
       
        listEventsSelected = [...new Set(listEventsSelected)] 
        selectedEventsValues.value = listEventsSelected
        
        if(listEventsSelected.length > 0){
          formSelect.style.visibility = "visible"
        }else{
          formSelect.style.visibility = "hidden"
        }
        quantity.innerHTML = listEventsSelected.length + quantityText
      })
  })

    </script>

    {% endblock %}