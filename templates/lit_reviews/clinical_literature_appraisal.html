{% extends 'base_lit_reviews.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% block 'help_section' %}
    <a  
        href="https://citemed-io.gitbook.io/citemed.io-documentation/full-text-review-extraction/filling-out-extraction-fields-and-forms" 
        target="_blank"
    >
        <span> Need help with this page? <br /> Read the Wiki</span>
        <div>
            <img src="{% static 'images/icons/wiki-icon.svg' %}">
        </div>
    </a>
{% endblock %}
{% block 'head' %}
<link href="{% static 'css/theme/extractions.css' %}" rel="stylesheet" type="text/css" />
{% endblock %}

{% block 'body' %}
<div id="appraisal_detail" v-cloak>
    <div v-if="isRecordsLoading" class="loading-message"> 
    </div>
    <div v-else>
        {% csrf_token %}
        <div id="" class="menu-navbar">
            <a v-for="item in menuNavItems" 
                :id="'nav-'+item.id"
                class="menu-navbar-item" 
                :class="{
                    'active': getCurrentTab === item.id,
                    'inactive': inactiveNavs[item.id]
                }"
                @click="setCurrentTab(item.id)" 
                :href="'#'+item.id"
            > 
                [[ item.displayName ]] 
            </a>
        </div>

        <div style="margin-top: 30px;"> </div>

        <div class="appraisal-details-card" id="article-details">
            <div class="header">
                Article Details
            </div>

            <div class="horizantal-devider"> </div>

            <div class="content">
                <div class="helper" v-if="article_review && article_review.search">
                    <span class="search-term-title">Article Related Search Term : </span> 
                    [[article_review.search.db.name]] -
                    <span>[[ displayedSearchTerm ]]</span>
                    
                    <span v-if="searchTerm.isLong && !searchTerm.expanded" 
                          class="link c-pointer"
                          @click="toggleSearchTerm">
                        ...(View More)
                    </span>
                    
                    <span v-if="searchTerm.isLong && searchTerm.expanded" 
                          class="link c-pointer"
                          @click="toggleSearchTerm">
                        (Show Less)
                    </span>
                </div>

                <div class="title mt-2">
                    <span v-if="article_review && article_review.processed_title" v-html="article_review.processed_title"></span>
                    <span v-else-if="article_review && article_review.article && article_review.article.title" v-html="article_review.article.title"></span>
                    <span v-else>No title available</span>
                </div>

                <div class="abstract mt-2">
                    <span v-if="article_review && article_review.processed_abstract" v-html="article_review.processed_abstract"></span>
                    <span v-else-if="article_review && article_review.article && article_review.article.abstract" v-html="article_review.article.abstract"></span>
                    <span v-else>No abstract available</span>
                </div>

                <div class="info-card mt-2" v-if="article_review && article_review.article && article_review.article.citation">
                    <span v-html="article_review.article.citation"></span>
                </div>

                

                <div class="info-card mt-2">
                    <div v-if="article_review && article_review.full_text_pdf">
                        <a class="center-v" :href="article_review.full_text_pdf" target="_blank">
                            <div class="file-download-icon mr">
                                <svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <g clip-path="url(#clip0_213_6862)">
                                        <path
                                            d="M4.46877 19.25L2.74658 17.5312H4.46877V19.25ZM17.5313 19.25L19.2535 17.5312H17.5313V19.25Z"
                                            fill="#A3313A" />
                                        <path d="M17.5312 4.46876H14.7847V1.7222L17.5312 4.46876Z" fill="#B2B2B2" />
                                        <path
                                            d="M14.7812 1.71875H5.01531C4.87036 1.71875 4.73133 1.77633 4.62883 1.87883C4.52633 1.98133 4.46875 2.12036 4.46875 2.26531V19.7966C4.46875 19.9418 4.52622 20.0812 4.62862 20.1843C4.73103 20.2873 4.87004 20.3457 5.01531 20.3466H16.9847C17.0581 20.3461 17.1307 20.331 17.1981 20.3021C17.2656 20.2732 17.3266 20.2311 17.3776 20.1782C17.4285 20.1254 17.4683 20.0628 17.4947 19.9943C17.5211 19.9258 17.5335 19.8527 17.5312 19.7794V4.46875H14.7812V1.71875Z"
                                            fill="#F1F1F1" />
                                        <path
                                            d="M3.09375 11.3438H18.9062C18.9974 11.3438 19.0849 11.38 19.1493 11.4444C19.2138 11.5089 19.25 11.5963 19.25 11.6875V17.5312H2.75V11.6875C2.75 11.5963 2.78622 11.5089 2.85068 11.4444C2.91515 11.38 3.00258 11.3438 3.09375 11.3438Z"
                                            fill="#C84D52" />
                                        <path
                                            d="M8.13672 14.8259V15.8125H7.44922V13.0006H8.54922C8.82664 12.9811 9.10063 13.0712 9.31234 13.2516C9.40371 13.3401 9.47471 13.4474 9.52042 13.5662C9.56613 13.6849 9.58544 13.8121 9.57703 13.9391C9.57883 14.1013 9.53856 14.2611 9.46016 14.4031C9.37963 14.5421 9.26012 14.6545 9.11641 14.7263C8.94171 14.8096 8.74954 14.8497 8.55609 14.8431L8.13672 14.8259ZM8.89297 13.9219C8.89297 13.6744 8.75547 13.5506 8.48047 13.5506H8.13672V14.2828H8.48047C8.75547 14.2828 8.89297 14.1625 8.89297 13.9219ZM12.2686 15.125C12.151 15.337 11.9742 15.5102 11.7598 15.6234C11.5189 15.7475 11.2505 15.809 10.9795 15.8022H9.91734V13.0006H10.9795C11.2501 12.9935 11.5183 13.0537 11.7598 13.1759C11.9749 13.2867 12.152 13.459 12.2686 13.6709C12.3892 13.8958 12.4496 14.148 12.4439 14.4031C12.447 14.6547 12.3867 14.9029 12.2686 15.125ZM11.5364 14.9841C11.6787 14.8193 11.7569 14.6088 11.7569 14.3911C11.7569 14.1734 11.6787 13.9629 11.5364 13.7981C11.3658 13.6495 11.1435 13.5742 10.9177 13.5884H10.598V15.1938H10.9177C11.1421 15.2109 11.3642 15.1393 11.5364 14.9944V14.9841ZM14.6645 13.0006V13.5438H13.5095V14.1591H14.3998V14.6747H13.5095V15.8125H12.822V13.0006H14.6645Z"
                                            fill="white" />
                                        <path
                                            d="M11.3092 3.61967C11.3345 3.85793 11.3111 4.09886 11.2404 4.3278C10.9345 5.38311 9.91013 9.22967 9.1367 9.77624C8.03326 10.56 7.4592 9.66967 8.04701 9.03717C8.63482 8.40467 12.1823 7.56249 13.3133 7.56249C14.7845 7.56249 14.5954 8.8653 13.7601 8.78624C12.8183 8.69686 10.4636 7.09155 10.3226 4.03905C10.2608 2.9528 11.2026 2.74999 11.3092 3.61967Z"
                                            stroke="#C84D52" stroke-miterlimit="10" />
                                    </g>
                                    <defs>
                                        <clipPath id="clip0_213_6862">
                                            <rect width="22" height="22" fill="white" />
                                        </clipPath>
                                    </defs>
                                </svg>
                            </div>
                            Article Full Text Click To Preview
                        </a>
                    </div>
                    <div v-else>
                        No FullText found on PMC, You need to Purchase or Upload it from <a href="{% url 'literature_reviews:full_text_upload' id=literature_review_id %}"> Here </a>.
                    </div>
                </div>

                <h4 class="mt-2 mb"> 
                    KW Highlighting ( Color Coded Highlighting - Edit Your Keywords 
                    <a href="{% url 'literature_reviews:keyword' id=literature_review_id %}" class="primary-link ml mr" target="_blank"> Here </a> ) 
                </h4>
                
                <!-- Article Notes section -->
                <div>
                    <h4>Article Notes: </h4>
                    <span v-if="article_review && article_review.notes" class="abstract hint mt">[[article_review.notes]]</span>
                    <span v-else class="abstract hint mt">N/A</span>
                </div>

                <!-- Article Keywords section -->
                <div>
                    <h4>Article Keywords: </h4>
                    <div class="abstract hint mt">  
                        <span v-if="article_review && article_review.keywords && article_review.keywords.length > 0">
                            <span v-for="(kw, index) in article_review.keywords" :key="index">
                                [[kw]]<span v-if="index < article_review.keywords.length - 1">, </span>
                            </span>
                        </span>
                        <span v-else>N/A</span>
                    </div>
                </div>

                <!-- Attached Tags section -->
                <div class="mt-2" v-if="article_review && article_review.tags && article_review.tags.length > 0">
                    <h3>Attached Tags:</h3>
                    <div class="center-v mt-2 mb">
                        <div 
                            v-for="tag in article_review.tags" 
                            :key="tag.id"
                            class="mr-2 badge" 
                            :style="{
                                backgroundColor: `rgba(${tag.hex_to_rgba[0]}, ${tag.hex_to_rgba[1]}, ${tag.hex_to_rgba[2]}, ${tag.hex_to_rgba[3]})`,
                                color: tag.color,
                                border: '1px solid ' + tag.color,
                                width: 'max-content',
                                padding: '5px 20px'
                            }"
                        > 
                            [[ tag.name ]]
                        </div>
                    </div>
                </div>
                <div class="mt-2" v-else>
                    <h3>Attached Tags: </h3>
                    <div class="center-v mt-2 mb">
                        <span>No tags available</span>
                    </div>
                </div>


                <div class="action-btns-section" v-if="article_review && article_review.article">
                    <div class="action-btns-section-item">
                        <button 
                            type="submit" 
                            class="secondary-gray-button" 
                            v-on:click="showFullTextPdf"
                        > 
                            <span v-if="showPdfViewer" class="btn-content">
                                <img class="header-right-icon" src="{% static 'images/icons/eye-closed-icon.svg' %}" alt="hide-pdf-file-icon" srcset="">
                                Hide Full Text PDF
                            </span>
                            <span v-else class="btn-content">
                                <img class="header-right-icon" src="{% static 'images/icons/eye-open-icon.svg' %}" alt="show-pdf-file-icon" srcset="">
                                Show Full Text PDF
                            </span>
                        </button>

                        <!--  Hide AI buttions from prod public environement -->
                        {% if SHOW_AI_BETA %}
                        <button 
                            class="secondary-gray-button" 
                            @click="autoGenerateExtractionFields()"
                            :disabled="aiLoading || !article_review.full_text_pdf"
                        >
                            <img class="header-right-icon" src="{% static 'images/icons/ai-icon.svg' %}" alt="show-pdf-file-icon" srcset="">
                            <span v-if="aiLoading && aiStatus !== 'completed'">
                                <i class="fas fa-spinner fa-spin"></i> Loading AI Fields...
                            </span>
                            <span v-else-if="aiStatus === 'completed' && !aiFieldsGenerated">
                                Show Generated Fields
                            </span>
                            <span v-else-if="aiFieldsGenerated">
                                Hide Generated Fields
                            </span>
                            <span v-else>
                                Auto Generate Extraction Fields
                            </span>
                        </button>
                        {% endif %}

                        <button 
                            v-if="aiStatus === 'completed'"
                            class="secondary-gray-button ml-2" 
                            @click="autoGenerateExtractionFields(true)"
                            :disabled="aiLoading"
                        >
                            <img class="header-right-icon" src="{% static 'images/icons/ai-icon.svg' %}" alt="show-pdf-file-icon" srcset="">
                            <span v-if="aiLoading">
                                <i class="fas fa-spinner fa-spin"></i> Loading AI Fields...
                            </span>
                            <span v-else>
                                Re-generate Fields
                            </span>
                        </button>
                    </div>
                    
                    <!-- If article has fulltext AND highlighted fulltext -->
                    <div v-if="article_review.article.full_text && article_review.article.highlighted_full_text" class="action-btns-section-item">
                        <a 
                            :href="article_review.article.highlighted_full_text"  
                            target="_blank"
                            class="secondary-gray-button"
                        > 
                            Review Highlighted KW
                        </a> 
                        <form 
                            v-on:submit="onHighlightPDF"
                            class="generate-highlighted-form w-50" 
                            method="post" 
                        >
                            <button 
                                type="submit" 
                                class="secondary-gray-button ml w-100"
                                :class="{loading: isHighlightPDFLoading}"
                                :disabled="isHighlightPDFLoading"
                            > 
                                Re-Generate KW Highlighted PDF 
                            </button>
                        </form>
                    </div>
                    
                    <!-- If article has fulltext but NO highlighted fulltext -->
                    <div v-else-if="article_review.article.full_text" class='action-btns-section-item'>
                        <form 
                            v-on:submit="onHighlightPDF"
                            class="generate-highlighted-form w-50" 
                            method="post" 
                        >
                            <button 
                                type="submit" 
                                class="secondary-gray-button ml w-100"
                                :class="{loading: isHighlightPDFLoading}"
                                :disabled="isHighlightPDFLoading"
                            > 
                                Generate KW Highlighted PDF 
                            </button>
                        </form>
                    </div>
                </div>

            </div>
        </div>


        <div class="appraisal-details-card" id="sub-exclutions">
            <div class="header center-v">
                Manage Sub-Groups
                <span class="tooltip-elt" title="By default each appraisal has 1 extraction field Value, by adding new sub extraction you are allowing multiple values for all extraction field.">
                    <img src="{% static 'images/icons/tooltip.svg' %}" alt="" srcset="">
                </span>
            </div>
            <div class="horizantal-devider"> </div>

            <div class="content">
                <div class="center-v">
                    <div v-for="subEx in subExtractions" class="center-v mb-2"> 
                        <div :class="subEx===1 ? 'badge primary' : 'badge secondary'" class="sub-extraction-badge">
                            [[subEx === 1 ? 'Default' : 'Sub #'+subEx ]]                     
                        </div>
                        <button v-if="subEx !== 1" v-on:click="showModal('delte-sub-extraction' + subEx)" :disabled="isArchived" :class="['error-outlined-button', { 'disabled': isArchived }]" class="ml mr sub-extraction-delete-btn">
                            <img src="{% static 'images/icons/delete-icon.svg' %}" alt="delete-icon" srcset="">  
                        </button>
                        <div class="sub-extraction-devider"> </div>

                        <!-- Delete Tag Modal -->
                        <div v-if="subEx !== 1" class="modal" :id="'delte-sub-extraction' + subEx">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <div class="modal-header-icon-wrapper delete-icon">
                                            <svg width="24" height="25" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M12 12.5V8M12 15.8354V15.875M21 12.5C21 17.4706 16.9706 21.5 12 21.5C7.02944 21.5 3 17.4706 3 12.5C3 7.52944 7.02944 3.5 12 3.5C16.9706 3.5 21 7.52944 21 12.5Z" stroke="#D92D20" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </div>
                                        Delete Sub Extraction #[[subEx]]
                                    </div>
                                    <div class="modal-body"> 
                                            All related inputs and their values for this  sub extraction #[[subEx]] will be deleted as well!
                                            Are you absolutely sure you want to delete?
                                    <div class="modal-footer">
                                        <button class="secondary-gray-button mr w-50" v-on:click="hideModal('delte-sub-extraction' + subEx)"> Cancel </button>
                                        <button class="error-button w-50" v-on:click="onDeleteSubExtraction($event, subEx)"> Yes, Delete </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <button v-on:click="onAddSubExtraction" class="secondary-gray-button mb-2">
                    Add Sub Extraction
                </button>
            </div>
        </div>
        </div>


        <div class="content-wrapper" :class="{ 'pdf-hidden': !showPdfViewer }">
            <!-- PDF Viewer Section -->
            <div v-if="showPdfViewer" class="pdf-section">
                <div class="appraisal-details-card" id="pdf-viewer">
                    <div class="header header-pdf">
                        <div class="header-left">
                            <span class="header-left-text">Full Text PDF</span>
                            <a :href="article_review.article.full_text.url" target="_blank">
                                <img class="header-left-icon" src="{% static 'images/icons/open-file.svg' %}" alt="open-pdf-file-icon" srcset="">  
                            </a>
                        </div>
                        <div class="header-right">
                            <button class="close-btn" v-on:click="closePdfViewer">
                                <img class="header-right-icon" src="{% static 'images/icons/eye-closed-icon.svg' %}" alt="hide-pdf-file-icon" srcset=""> 
                                Hide Full Text PDF
                            </button>
                        </div>
                    </div>
                    <div class="horizantal-devider"></div>
                    <div class="content pdf-content">
                        <div v-if="pdfUrl" class="pdf-container">
                            <embed 
                                :src="pdfUrl" 
                                type="application/pdf"
                            />
                        </div>
                        <div v-else class="no-pdf-message">
                            No PDF available for this article.
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section" id="appraisal-form">

                <div class="appraisal-details-card" id="suitability-outcomes">
                    <div class="header">
                        Suitability and Outcomes (All Articles including SoTA)
                    </div>
                    <div class="horizantal-devider"> </div>

                    <div class="content">
                        <div class="col" v-for="field in formFields.suitabilityOutcomes" :key="field.id">
                            <div :id="'div_id_' + field.id" class="form-group">
                                <label :for="'id_' + field.id">
                                    [[ field.description || formatFieldName(field.name) ]]
                                </label>
                                <!-- Dropdown for DROP_DOWN type -->
                                <div v-if="field.field_type === 'DROP_DOWN'">
                                    <div class="input-with-controls">
                                        <!-- AI icon container -->
                                        <div class="ai-icon-container" v-if="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'">
                                            <img src="{% static 'images/icons/ai-blue-icon.svg' %}" alt="AI">
                                        </div>
                                        
                                        <select 
                                            :name="field.id + '-' + field.name"
                                            :id="'id_' + field.id"
                                            class="select form-control"
                                            v-model="formValues[field.name]"
                                            :disabled="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'"
                                            :class="{ 'field-disabled': aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed' }"
                                        >
                                            <option value="">---------</option>
                                            <option 
                                                v-for="option in JSON.parse(field.drop_down_values)" 
                                                :key="option" 
                                                :value="option"
                                            >
                                                [[ option ]]
                                            </option>
                                        </select>
                                        
                                        <!-- AI Controls with icons -->
                                        <div v-if="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'" class="ai-controls">
                                            <button 
                                                class="ai-button accept-btn" 
                                                @click="acceptAIValue(field)"
                                                title="Accept AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-accepted.svg' %}" alt="Accept">
                                            </button>
                                            <button 
                                                class="ai-button edit-btn" 
                                                @click="editAIValue(field)"
                                                title="Edit AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-edited.svg' %}" alt="Edit">
                                            </button>
                                            <button 
                                                class="ai-button refuse-btn" 
                                                @click="refuseAIValue(field)"
                                                title="Reject AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-rejected.svg' %}" alt="Reject">
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <!-- Text input for TEXT type -->
                                <div v-if="field.field_type === 'TEXT'">
                                    <div class="input-with-controls">
                                        <!-- AI icon container -->
                                        <div class="ai-icon-container" v-if="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'">
                                            <img src="{% static 'images/icons/ai-blue-icon.svg' %}" alt="AI">
                                        </div>
                                        
                                        <input 
                                            type="text" 
                                            :name="field.id + '-' + field.name"
                                            :id="'id_' + field.id"
                                            class="textinput form-control"
                                            v-model="formValues[field.name]"
                                            :disabled="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'"
                                            :class="{ 'field-disabled': aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed' }"
                                        >
                                        
                                        <!-- AI Controls with icons -->
                                        <div v-if="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'" class="ai-controls">
                                            <button 
                                                class="ai-button accept-btn" 
                                                @click="acceptAIValue(field)"
                                                title="Accept AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-accepted.svg' %}" alt="Accept">
                                            </button>
                                            <button 
                                                class="ai-button edit-btn" 
                                                @click="editAIValue(field)"
                                                title="Edit AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-edited.svg' %}" alt="Edit">
                                            </button>
                                            <button 
                                                class="ai-button refuse-btn" 
                                                @click="refuseAIValue(field)"
                                                title="Reject AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-rejected.svg' %}" alt="Reject">
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <!-- Textarea for LONG_TEXT type -->
                                <div v-if="field.field_type === 'LONG_TEXT'" class="long-text-field">
                                    <div class="input-with-controls">
                                        <!-- AI icon container -->
                                        <div class="ai-icon-container" v-if="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'">
                                            <img src="{% static 'images/icons/ai-blue-icon.svg' %}" alt="AI">
                                        </div>
                                        
                                        <textarea 
                                            :name="field.id + '-' + field.name"
                                            :id="'id_' + field.id"
                                            class="textarea form-control"
                                            v-model="formValues[field.name]"
                                            :disabled="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'"
                                            :class="{ 'field-disabled': aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed' }"
                                        ></textarea>
                                        
                                        <!-- AI Controls with icons -->
                                        <div v-if="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'" class="ai-controls">
                                            <button 
                                                class="ai-button accept-btn" 
                                                @click="acceptAIValue(field)"
                                                title="Accept AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-accepted.svg' %}" alt="Accept">
                                            </button>
                                            <button 
                                                class="ai-button edit-btn" 
                                                @click="editAIValue(field)"
                                                title="Edit AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-edited.svg' %}" alt="Edit">
                                            </button>
                                            <button 
                                                class="ai-button refuse-btn" 
                                                @click="refuseAIValue(field)"
                                                title="Reject AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-rejected.svg' %}" alt="Reject">
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <!-- Hidden fields -->
                                <input type="hidden" :name="field.id + '-obj_id'" :value="field.id">
                                <input type="hidden" :name="field.id + '-field_section'" value="SO">
                                <input type="hidden" :name="field.id + '-extraction_field_number'" :value="field.extraction_field_number">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="appraisal-details-card" id="inclusion-sota">
                    <div class="header">
                        Inclusion and Device/Sota Decision (All Articles)
                    </div>
                    <div class="horizantal-devider"></div>
                
                    <div class="content">
                        <div class="form-group">
                            <label for="id_included">Included</label>
                            <select 
                                name="included" 
                                id="id_included" 
                                class="select form-control included"
                                v-model="formValues.included"
                            >
                                <option value="">Unknown</option>
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                
                        <div class="form-group">
                            <label for="id_is_sota_article">Is this article a SoTA Article?</label>
                            <select 
                                name="is_sota_article" 
                                id="id_is_sota_article" 
                                class="select form-control is_sota_article"
                                v-model="formValues.is_sota_article"
                            >
                                <option value="">Unknown</option>
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="appraisal-details-card device included-yes" 
                    id="quality-contribution"
                    v-show="showDevice"
                >
                    <div class="header">
                        Quality and Contribution Questions
                    </div>
                    <div class="horizantal-devider"></div>
                
                    <div class="content">
                        <div class="col" v-for="field in formFields.qualityContribution" :key="field.id">
                            <div :id="'div_id_' + field.id" class="form-group">
                                <label :for="'id_' + field.id">
                                    [[ field.description || formatFieldName(field.name) ]]
                                </label>
                                <!-- Dropdown for DROP_DOWN type -->
                                <div v-if="field.field_type === 'DROP_DOWN'">
                                    <div class="input-with-controls">
                                        <!-- AI icon container -->
                                        <div class="ai-icon-container" v-if="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'">
                                            <img src="{% static 'images/icons/ai-blue-icon.svg' %}" alt="AI">
                                        </div>
                                        
                                        <select 
                                            :name="field.id + '-' + field.name"
                                            :id="'id_' + field.id"
                                            class="select form-control"
                                            v-model="formValues[field.name]"
                                            :disabled="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'"
                                            :class="{ 'field-disabled': aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed' }"
                                        >
                                            <option value="">---------</option>
                                            <option 
                                                v-for="option in JSON.parse(field.drop_down_values)" 
                                                :key="option" 
                                                :value="option"
                                            >
                                                [[ option ]]
                                            </option>
                                        </select>
                                        
                                        <!-- AI Controls with icons -->
                                        <div v-if="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'" class="ai-controls">
                                            <button 
                                                class="ai-button accept-btn" 
                                                @click="acceptAIValue(field)"
                                                title="Accept AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-accepted.svg' %}" alt="Accept">
                                            </button>
                                            <button 
                                                class="ai-button edit-btn" 
                                                @click="editAIValue(field)"
                                                title="Edit AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-edited.svg' %}" alt="Edit">
                                            </button>
                                            <button 
                                                class="ai-button refuse-btn" 
                                                @click="refuseAIValue(field)"
                                                title="Reject AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-rejected.svg' %}" alt="Reject">
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <!-- Text input for TEXT type -->
                                <div v-if="field.field_type === 'TEXT'">
                                    <div class="input-with-controls">
                                        <!-- AI icon container -->
                                        <div class="ai-icon-container" v-if="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'">
                                            <img src="{% static 'images/icons/ai-blue-icon.svg' %}" alt="AI">
                                        </div>
                                        
                                        <input 
                                            type="text" 
                                            :name="field.id + '-' + field.name"
                                            :id="'id_' + field.id"
                                            class="textinput form-control"
                                            v-model="formValues[field.name]"
                                            :disabled="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'"
                                            :class="{ 'field-disabled': aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed' }"
                                        >
                                        
                                        <!-- AI Controls with icons -->
                                        <div v-if="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'" class="ai-controls">
                                            <button 
                                                class="ai-button accept-btn" 
                                                @click="acceptAIValue(field)"
                                                title="Accept AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-accepted.svg' %}" alt="Accept">
                                            </button>
                                            <button 
                                                class="ai-button edit-btn" 
                                                @click="editAIValue(field)"
                                                title="Edit AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-edited.svg' %}" alt="Edit">
                                            </button>
                                            <button 
                                                class="ai-button refuse-btn" 
                                                @click="refuseAIValue(field)"
                                                title="Reject AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-rejected.svg' %}" alt="Reject">
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <!-- Hidden fields -->
                                <input type="hidden" :name="field.id + '-obj_id'" :value="field.id">
                                <input type="hidden" :name="field.id + '-field_section'" value="QC">
                                <input type="hidden" :name="field.id + '-extraction_field_number'" :value="field.extraction_field_number">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="appraisal-details-card device included-yes" 
                    id="mdcg-ranking"
                    v-show="showDevice"
                >
                    <div class="header center-v">
                        MDCG Ranking
                        <span class="tooltip-elt" title="This field is for Evidence Ranking">
                            <img src="{% static 'images/icons/tooltip.svg' %}" alt="" srcset="">
                        </span>
                    </div>
                    <div class="horizantal-devider"></div>
                
                    <div class="content">
                        <div class="col" v-for="field in formFields.mdcgRanking" :key="field.id">
                            <div :id="'div_id_' + field.id" class="form-group">
                                <label :for="'id_' + field.id">
                                    [[ field.description || formatFieldName(field.name) ]]
                                </label>
                                <!-- Dropdown for DROP_DOWN type -->
                                <div v-if="field.field_type === 'DROP_DOWN'">
                                    <div class="input-with-controls">
                                        <!-- AI icon container -->
                                        <div class="ai-icon-container" v-if="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'">
                                            <img src="{% static 'images/icons/ai-blue-icon.svg' %}" alt="AI">
                                        </div>
                                        
                                        <select 
                                            :name="field.id + '-' + field.name"
                                            :id="'id_' + field.id"
                                            class="select form-control"
                                            v-model="formValues[field.name]"
                                            :disabled="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'"
                                            :class="{ 'field-disabled': aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed' }"
                                        >
                                            <option value="">---------</option>
                                            <option 
                                                v-for="option in JSON.parse(field.drop_down_values)" 
                                                :key="option" 
                                                :value="option"
                                            >
                                                [[ option ]]
                                            </option>
                                        </select>
                                        
                                        <!-- AI Controls with icons -->
                                        <div v-if="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'" class="ai-controls">
                                            <button 
                                                class="ai-button accept-btn" 
                                                @click="acceptAIValue(field)"
                                                title="Accept AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-accepted.svg' %}" alt="Accept">
                                            </button>
                                            <button 
                                                class="ai-button edit-btn" 
                                                @click="editAIValue(field)"
                                                title="Edit AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-edited.svg' %}" alt="Edit">
                                            </button>
                                            <button 
                                                class="ai-button refuse-btn" 
                                                @click="refuseAIValue(field)"
                                                title="Reject AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-rejected.svg' %}" alt="Reject">
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <!-- Text input for TEXT type -->
                                <div v-if="field.field_type === 'TEXT'">
                                    <div class="input-with-controls">
                                        <!-- AI icon container -->
                                        <div class="ai-icon-container" v-if="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'">
                                            <img src="{% static 'images/icons/ai-blue-icon.svg' %}" alt="AI">
                                        </div>
                                        
                                        <input 
                                            type="text" 
                                            :name="field.id + '-' + field.name"
                                            :id="'id_' + field.id"
                                            class="textinput form-control"
                                            v-model="formValues[field.name]"
                                            :disabled="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'"
                                            :class="{ 'field-disabled': aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed' }"
                                        >
                                        
                                        <!-- AI Controls with icons -->
                                        <div v-if="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'" class="ai-controls">
                                            <button 
                                                class="ai-button accept-btn" 
                                                @click="acceptAIValue(field)"
                                                title="Accept AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-accepted.svg' %}" alt="Accept">
                                            </button>
                                            <button 
                                                class="ai-button edit-btn" 
                                                @click="editAIValue(field)"
                                                title="Edit AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-edited.svg' %}" alt="Edit">
                                            </button>
                                            <button 
                                                class="ai-button refuse-btn" 
                                                @click="refuseAIValue(field)"
                                                title="Reject AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-rejected.svg' %}" alt="Reject">
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <!-- Hidden fields -->
                                <input type="hidden" :name="field.id + '-obj_id'" :value="field.id">
                                <input type="hidden" :name="field.id + '-field_section'" value="MR">
                                <input type="hidden" :name="field.id + '-extraction_field_number'" :value="field.extraction_field_number">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="appraisal-details-card sota" 
                    id="sota"
                    v-show="showSota"
                >
                    <div class="header">
                        SoTA
                    </div>
                    <div class="horizantal-devider"></div>
                
                    <div class="content">
                        <div class="col" v-for="field in formFields.stateOfTheArt" :key="field.id">
                            <div :id="'div_id_' + field.id" class="form-group">
                                <label :for="'id_' + field.id">
                                    [[ field.description || formatFieldName(field.name) ]]
                                </label>
                                <!-- Dropdown for DROP_DOWN type -->
                                <div v-if="field.field_type === 'DROP_DOWN'">
                                    <div class="input-with-controls">
                                        <!-- AI icon container -->
                                        <div class="ai-icon-container" v-if="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'">
                                            <img src="{% static 'images/icons/ai-blue-icon.svg' %}" alt="AI">
                                        </div>
                                        
                                        <select 
                                            :name="field.id + '-' + field.name"
                                            :id="'id_' + field.id"
                                            class="select form-control"
                                            v-model="formValues[field.name]"
                                            :disabled="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'"
                                            :class="{ 'field-disabled': aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed' }"
                                        >
                                            <option value="">---------</option>
                                            <option 
                                                v-for="option in JSON.parse(field.drop_down_values)" 
                                                :key="option" 
                                                :value="option"
                                            >
                                                [[ option ]]
                                            </option>
                                        </select>
                                        
                                        <!-- AI Controls with icons -->
                                        <div v-if="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'" class="ai-controls">
                                            <button 
                                                class="ai-button accept-btn" 
                                                @click="acceptAIValue(field)"
                                                title="Accept AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-accepted.svg' %}" alt="Accept">
                                            </button>
                                            <button 
                                                class="ai-button edit-btn" 
                                                @click="editAIValue(field)"
                                                title="Edit AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-edited.svg' %}" alt="Edit">
                                            </button>
                                            <button 
                                                class="ai-button refuse-btn" 
                                                @click="refuseAIValue(field)"
                                                title="Reject AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-rejected.svg' %}" alt="Reject">
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <!-- Text input for TEXT type -->
                                <div v-if="field.field_type === 'TEXT'">
                                    <div class="input-with-controls">
                                        <!-- AI icon container -->
                                        <div class="ai-icon-container" v-if="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'">
                                            <img src="{% static 'images/icons/ai-blue-icon.svg' %}" alt="AI">
                                        </div>
                                        
                                        <input 
                                            type="text" 
                                            :name="field.id + '-' + field.name"
                                            :id="'id_' + field.id"
                                            class="textinput form-control"
                                            v-model="formValues[field.name]"
                                            :disabled="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'"
                                            :class="{ 'field-disabled': aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed' }"
                                        >
                                        
                                        <!-- AI Controls with icons -->
                                        <div v-if="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'" class="ai-controls">
                                            <button 
                                                class="ai-button accept-btn" 
                                                @click="acceptAIValue(field)"
                                                title="Accept AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-accepted.svg' %}" alt="Accept">
                                            </button>
                                            <button 
                                                class="ai-button edit-btn" 
                                                @click="editAIValue(field)"
                                                title="Edit AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-edited.svg' %}" alt="Edit">
                                            </button>
                                            <button 
                                                class="ai-button refuse-btn" 
                                                @click="refuseAIValue(field)"
                                                title="Reject AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-rejected.svg' %}" alt="Reject">
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <!-- Textarea for LONG_TEXT type -->
                                <div v-if="field.field_type === 'LONG_TEXT'" class="long-text-field">
                                    <div class="input-with-controls">
                                        <!-- AI icon container -->
                                        <div class="ai-icon-container" v-if="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'">
                                            <img src="{% static 'images/icons/ai-blue-icon.svg' %}" alt="AI">
                                        </div>
                                        
                                        <textarea 
                                            :name="field.id + '-' + field.name"
                                            :id="'id_' + field.id"
                                            class="textarea form-control"
                                            v-model="formValues[field.name]"
                                            :disabled="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'"
                                            :class="{ 'field-disabled': aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed' }"
                                        ></textarea>
                                        
                                        <!-- AI Controls with icons -->
                                        <div v-if="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'" class="ai-controls">
                                            <button 
                                                class="ai-button accept-btn" 
                                                @click="acceptAIValue(field)"
                                                title="Accept AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-accepted.svg' %}" alt="Accept">
                                            </button>
                                            <button 
                                                class="ai-button edit-btn" 
                                                @click="editAIValue(field)"
                                                title="Edit AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-edited.svg' %}" alt="Edit">
                                            </button>
                                            <button 
                                                class="ai-button refuse-btn" 
                                                @click="refuseAIValue(field)"
                                                title="Reject AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-rejected.svg' %}" alt="Reject">
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <!-- Hidden fields -->
                                <input type="hidden" :name="field.id + '-obj_id'" :value="field.id">
                                <input type="hidden" :name="field.id + '-field_section'" value="ST">
                                <input type="hidden" :name="field.id + '-extraction_field_number'" :value="field.extraction_field_number">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="appraisal-details-card device included-yes" 
                    id="extra-extraction-fields"
                    v-show="showDevice"
                >
                    <div class="header">
                        Extraction Fields
                    </div>
                    <div class="horizantal-devider"></div>

                    <div class="content extractions">
                        <div class="col" v-for="fieldGroup in groupedExtractionFields" :key="fieldGroup.label">
                            <div class="field-group">
                                <label class="label">
                                    [[ fieldGroup.label.replace(/_/g, ' ').charAt(0).toUpperCase() + fieldGroup.label.replace(/_/g, ' ').slice(1) ]]
                                </label>
                                
                                <div v-for="field in fieldGroup.fields" :key="field.id" class="sub-field">
                                    <div :id="'div_id_' + field.id" class="form-group">
                                        <label :for="'id_' + field.id" class="sub-field-label">
                                            <span v-if="field.extraction_field_number > 1" class="sub-extraction-number">
                                                Sub #[[field.extraction_field_number]]
                                            </span>
                                        </label>
                                        
                                        <!-- Dropdown for DROP_DOWN type -->
                                        <div v-if="field.field_type === 'DROP_DOWN'">
                                            <div class="input-with-controls">
                                                <!-- AI icon container -->
                                                <div class="ai-icon-container" v-if="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'">
                                                    <img src="{% static 'images/icons/ai-blue-icon.svg' %}" alt="AI">
                                                </div>
                                                
                                                <select 
                                                    :name="field.id + '-' + field.name"
                                                    :id="'id_' + field.id"
                                                    class="select form-control"
                                                    v-model="formValues[field.name]"
                                                    :disabled="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'"
                                                    :class="{ 'field-disabled': aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed' }"
                                                >
                                                    <option value="">---------</option>
                                                    <option 
                                                        v-for="option in JSON.parse(field.drop_down_values)" 
                                                        :key="option" 
                                                        :value="option"
                                                    >
                                                        [[ option ]]
                                                    </option>
                                                </select>
                                                
                                                <!-- AI Controls with icons -->
                                                <div v-if="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'" class="ai-controls">
                                                    <button 
                                                        class="ai-button accept-btn" 
                                                        @click="acceptAIValue(field)"
                                                        title="Accept AI suggestion"
                                                    >
                                                        <img src="{% static 'images/icons/ai-accepted.svg' %}" alt="Accept">
                                                    </button>
                                                    <button 
                                                        class="ai-button edit-btn" 
                                                        @click="editAIValue(field)"
                                                        title="Edit AI suggestion"
                                                    >
                                                        <img src="{% static 'images/icons/ai-edited.svg' %}" alt="Edit">
                                                    </button>
                                                    <button 
                                                        class="ai-button refuse-btn" 
                                                        @click="refuseAIValue(field)"
                                                        title="Reject AI suggestion"
                                                    >
                                                        <img src="{% static 'images/icons/ai-rejected.svg' %}" alt="Reject">
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Text input for TEXT type -->
                                        <div v-if="field.field_type === 'TEXT'">
                                            <div class="input-with-controls">
                                                <!-- AI icon container -->
                                                <div class="ai-icon-container" v-if="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'">
                                                    <img src="{% static 'images/icons/ai-blue-icon.svg' %}" alt="AI">
                                                </div>
                                                
                                                <input 
                                                    type="text" 
                                                    :name="field.id + '-' + field.name"
                                                    :id="'id_' + field.id"
                                                    class="textinput form-control"
                                                    v-model="formValues[`${field.name}_${field.extraction_field_number}`]"
                                                    :disabled="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'"
                                                    :class="{ 
                                                        'field-disabled': aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed',
                                                        'field-simplified': aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'simplified'
                                                    }"
                                                >
                                                
                                                <!-- AI Controls with icons -->
                                                <div v-if="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'" class="ai-controls">
                                                    <button 
                                                        class="ai-button accept-btn" 
                                                        @click="acceptAIValue(field)"
                                                        title="Accept AI suggestion"
                                                    >
                                                        <img src="{% static 'images/icons/ai-accepted.svg' %}" alt="Accept">
                                                    </button>
                                                    <button 
                                                        class="ai-button edit-btn" 
                                                        @click="editAIValue(field)"
                                                        title="Edit AI suggestion"
                                                    >
                                                        <img src="{% static 'images/icons/ai-edited.svg' %}" alt="Edit">
                                                    </button>
                                                    <button 
                                                        class="ai-button refuse-btn" 
                                                        @click="refuseAIValue(field)"
                                                        title="Reject AI suggestion"
                                                    >
                                                        <img src="{% static 'images/icons/ai-rejected.svg' %}" alt="Reject">
                                                    </button>
                                                    <button 
                                                        class="ai-button simplified-btn" 
                                                        @click="useSimplifiedAIValue(field)"
                                                        :class="{ 'active-simplified': field.showing_simplified }"
                                                        title="Simplified version"
                                                        >
                                                        <img src="{% static 'images/icons/ai-simplified.svg' %}" alt="Simplified">
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Textarea for LONG_TEXT type -->
                                        <div v-if="field.field_type === 'LONG_TEXT'" class="long-text-field">
                                            <div class="input-with-controls">
                                                <!-- AI icon container -->
                                                <div class="ai-icon-container" v-if="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'">
                                                    <img src="{% static 'images/icons/ai-blue-icon.svg' %}" alt="AI">
                                                </div>
                                                
                                                <textarea 
                                                    :name="field.id + '-' + field.name"
                                                    :id="'id_' + field.id"
                                                    class="textarea form-control"
                                                    v-model="formValues[`${field.name}_${field.extraction_field_number}`]"
                                                    :disabled="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'"
                                                    :class="{ 'field-disabled': aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed' }"
                                                ></textarea>
                                                
                                                <!-- AI Controls with icons -->
                                                <div v-if="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'" class="ai-controls">
                                                    <button 
                                                        class="ai-button accept-btn" 
                                                        @click="acceptAIValue(field)"
                                                        title="Accept AI suggestion"
                                                    >
                                                        <img src="{% static 'images/icons/ai-accepted.svg' %}" alt="Accept">
                                                    </button>
                                                    <button 
                                                        class="ai-button edit-btn" 
                                                        @click="editAIValue(field)"
                                                        title="Edit AI suggestion"
                                                    >
                                                        <img src="{% static 'images/icons/ai-edited.svg' %}" alt="Edit">
                                                    </button>
                                                    <button 
                                                        class="ai-button refuse-btn" 
                                                        @click="refuseAIValue(field)"
                                                        title="Reject AI suggestion"
                                                    >
                                                        <img src="{% static 'images/icons/ai-rejected.svg' %}" alt="Reject">
                                                    </button>
                                                    <button 
                                                        class="ai-button simplified-btn" 
                                                        @click="useSimplifiedAIValue(field)"
                                                        :class="{ 'active-simplified': field.showing_simplified }"
                                                        title="Simplified version"
                                                        >
                                                        <img src="{% static 'images/icons/ai-simplified.svg' %}" alt="Simplified">
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Hidden fields -->
                                        <input type="hidden" :name="field.id + '-obj_id'" :value="field.id">
                                        <input type="hidden" :name="field.id + '-field_section'" :value="field.field_section">
                                        <input type="hidden" :name="field.id + '-extraction_field_number'" :value="field.extraction_field_number">
                                        <input type="hidden" v-if="field.ai_value" :name="field.id + '-original_value'" :value="field.original_value">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="appraisal-details-card device included-yes" 
                    id="extra-extraction-fields"
                    v-show="showDevice && formFields.customSection.lenght"
                >
                    <div class="header">
                        Custom Extractions 
                    </div>
                    <div class="horizantal-devider"></div>

                    <div class="content">
                        <div class="col" v-for="field in formFields.customSection" :key="field.id">
                            <div :id="'div_id_' + field.id" class="form-group">
                                <label :for="'id_' + field.id">
                                    [[ field.description || formatFieldName(field.name) ]]
                                </label>
                                <!-- Dropdown for DROP_DOWN type -->
                                <div v-if="field.field_type === 'DROP_DOWN'">
                                    <div class="input-with-controls">
                                        <!-- AI icon container -->
                                        <div class="ai-icon-container" v-if="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'">
                                            <img src="{% static 'images/icons/ai-blue-icon.svg' %}" alt="AI">
                                        </div>
                                        
                                        <select 
                                            :name="field.id + '-' + field.name"
                                            :id="'id_' + field.id"
                                            class="select form-control"
                                            v-model="formValues[field.name]"
                                            :disabled="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'"
                                            :class="{ 'field-disabled': aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed' }"
                                        >
                                            <option value="">---------</option>
                                            <option 
                                                v-for="option in JSON.parse(field.drop_down_values)" 
                                                :key="option" 
                                                :value="option"
                                            >
                                                [[ option ]]
                                            </option>
                                        </select>
                                        
                                        <!-- AI Controls with icons -->
                                        <div v-if="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'" class="ai-controls">
                                            <button 
                                                class="ai-button accept-btn" 
                                                @click="acceptAIValue(field)"
                                                title="Accept AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-accepted.svg' %}" alt="Accept">
                                            </button>
                                            <button 
                                                class="ai-button edit-btn" 
                                                @click="editAIValue(field)"
                                                title="Edit AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-edited.svg' %}" alt="Edit">
                                            </button>
                                            <button 
                                                class="ai-button refuse-btn" 
                                                @click="refuseAIValue(field)"
                                                title="Reject AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-rejected.svg' %}" alt="Reject">
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Text input for TEXT type -->
                                <div v-if="field.field_type === 'TEXT'">
                                    <div class="input-with-controls">
                                        <!-- AI icon container -->
                                        <div class="ai-icon-container" v-if="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'">
                                            <img src="{% static 'images/icons/ai-blue-icon.svg' %}" alt="AI">
                                        </div>
                                        
                                        <input 
                                            type="text" 
                                            :name="field.id + '-' + field.name"
                                            :id="'id_' + field.id"
                                            class="textinput form-control"
                                            v-model="formValues[field.name]"
                                            :disabled="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'"
                                            :class="{ 'field-disabled': aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed' }"
                                        >
                                        
                                        <!-- AI Controls with icons -->
                                        <div v-if="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'" class="ai-controls">
                                            <button 
                                                class="ai-button accept-btn" 
                                                @click="acceptAIValue(field)"
                                                title="Accept AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-accepted.svg' %}" alt="Accept">
                                            </button>
                                            <button 
                                                class="ai-button edit-btn" 
                                                @click="editAIValue(field)"
                                                title="Edit AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-edited.svg' %}" alt="Edit">
                                            </button>
                                            <button 
                                                class="ai-button refuse-btn" 
                                                @click="refuseAIValue(field)"
                                                title="Reject AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-rejected.svg' %}" alt="Reject">
                                            </button>
                                            <button 
                                                class="ai-button simplified-btn" 
                                                @click="useSimplifiedAIValue(field)"
                                                :class="{ 'active-simplified': field.showing_simplified }"
                                                title="Simplified version"
                                                >
                                                <img src="{% static 'images/icons/ai-simplified.svg' %}" alt="Simplified">
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Textarea for LONG_TEXT type -->
                                <div v-if="field.field_type === 'LONG_TEXT'" class="long-text-field">
                                    <div class="input-with-controls">
                                        <!-- AI icon container -->
                                        <div class="ai-icon-container" v-if="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'">
                                            <img src="{% static 'images/icons/ai-blue-icon.svg' %}" alt="AI">
                                        </div>
                                        
                                        <textarea 
                                            :name="field.id + '-' + field.name"
                                            :id="'id_' + field.id"
                                            class="textarea form-control"
                                            v-model="formValues[field.name]"
                                            :disabled="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'"
                                            :class="{ 'field-disabled': aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed' }"
                                        ></textarea>
                                        
                                        <!-- AI Controls with icons -->
                                        <div v-if="aiFieldsGenerated && field.ai_value && aiStatuses[field.id] === 'not_reviewed'" class="ai-controls">
                                            <button 
                                                class="ai-button accept-btn" 
                                                @click="acceptAIValue(field)"
                                                title="Accept AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-accepted.svg' %}" alt="Accept">
                                            </button>
                                            <button 
                                                class="ai-button edit-btn" 
                                                @click="editAIValue(field)"
                                                title="Edit AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-edited.svg' %}" alt="Edit">
                                            </button>
                                            <button 
                                                class="ai-button refuse-btn" 
                                                @click="refuseAIValue(field)"
                                                title="Reject AI suggestion"
                                            >
                                                <img src="{% static 'images/icons/ai-rejected.svg' %}" alt="Reject">
                                            </button>
                                            <button 
                                                class="ai-button simplified-btn" 
                                                @click="useSimplifiedAIValue(field)"
                                                :class="{ 'active-simplified': field.showing_simplified }"
                                                title="Simplified version"
                                                >
                                                <img src="{% static 'images/icons/ai-simplified.svg' %}" alt="Simplified">
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Hidden fields -->
                                <input type="hidden" :name="field.id + '-obj_id'" :value="field.id">
                                <input type="hidden" :name="field.id + '-field_section'" value="MR">
                                <input type="hidden" :name="field.id + '-extraction_field_number'" :value="field.extraction_field_number">
                            </div>
                        </div>
                    </div>
                </div>


                <div class="appraisal-details-card justification" 
                    id="justification-fields"
                    v-show="showJustification"
                >
                    <div class="header">
                        Exclusion Justification
                    </div>
                    <div class="horizantal-devider"></div>
                
                    <div class="content">
                        <div class="form-group">
                            <label for="id_justification">Justification</label>
                            <textarea 
                                name="justification" 
                                id="id_justification" 
                                class="textarea form-control"
                                v-model="formValues.justification"
                            ></textarea>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 30px;"></div>

                <div class="form-actions"> 
                        <a 
                            class="secondary-gray-button mr" 
                            type="button" 
                            href="{% url 'literature_reviews:clinical_literature_appraisal_list' id=literature_review_id %}"
                        >
                            Cancel
                        </a>
                        <div class="form-actions-right-btns">
                            <a :class="['secondary-gray-button mr', { 'disabled': !previousAppraisalId }]"  v-on:click="generateUrl(previousAppraisalId)"> 
                                <div class="center-v">
                                    <svg class="mr" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M7.11083 12.6667L2.66638 8M2.66638 8L7.11083 3.33333M2.66638 8L13.333 8" stroke="#181A1E" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    Previous 
                                </div>
                            </a>
                            
                            <a :class="['secondary-gray-button mr', { 'disabled': !nextAppraisalId }]" v-on:click="generateUrl(nextAppraisalId)"> 
                                <div class="center-v">
                                    Next
                                    <svg class="ml" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M8.88885 3.33333L13.3333 8M13.3333 8L8.88885 12.6667M13.3333 8L2.66663 8" stroke="#181A1E" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                            </a>
                            {% if is_archived %}
                                <button 
                                    type="button" 
                                    class="primary-button" 
                                    v-on:click="submitForm" 
                                    disabled="disabled"
                                > 
                                    Save and Next 
                                </button>
                            {% else %}
                                <button 
                                    type="button" 
                                    class="primary-button" 
                                    v-on:click="submitForm" 
                                > 
                                    Save and Next 
                                </button>
                            {% endif %}
                        </div> 
                </div>    
                <div style="margin-top: 60px;"> </div>
            </div>
        </div>

        <div class="modal" id="unreviewed-ai-fields-modal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-header-icon-wrapper warning-icon">
                            <svg width="24" height="25" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 12.5V8M12 15.8354V15.875M21 12.5C21 17.4706 16.9706 21.5 12 21.5C7.02944 21.5 3 17.4706 3 12.5C3 7.52944 7.02944 3.5 12 3.5C16.9706 3.5 21 7.52944 21 12.5Z" stroke="#F79009" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        Unreviewed AI Fields
                    </div>
                    <div class="modal-body">
                        <p>There are AI-generated fields that you haven't reviewed yet. What would you like to do?</p>
                    </div>
                    <div class="modal-footer">
                        <button class="secondary-gray-button mr w-50" @click="hideModal('unreviewed-ai-fields-modal')">Cancel</button>
                        <button class="primary-button w-50" @click="hideAIFieldsAndSave()">Hide AI Fields & Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- loader section #2 -->
    <div class="update-loading-section" id="loading-section">
        <div class="update-loading-popup">
        <div class="mb-3">
            <img src="{% static 'images/new_logo.svg' %}" class="d-inline-block align-top" alt="citemed-logo" />
        </div>

        <div class="update-loading-popup-text">
            An action is taking place, please don't refresh the page Until the process is completed! this process may take a
            few minutes.
        </div>

        <div class="update-loading-popup-progress">
            <div></div>
            <div></div>
            <div></div>
        </div>
        </div>
    </div>
</div>
{% endblock %}

{% block 'scripts-block' %}
<script>
    const currentAppraisalId = "{{appraisal_id}}";
    const currentSorting = "{{ request.GET.sorting }}";
    const searchTitle = "{{ request.GET.search_title }}";
    const filterStatus = "{{ request.GET.filter_status }}";
    const filterIsSota = "{{ request.GET.filter_is_sota }}";
    const filterIsCk3 = "{{ request.GET.filter_is_ck3 }}";
    const NavigationListAPI = "{% url 'lit_reviews:appraisal_navigation_api' id=literature_review_id %}";
    const AddSubExtractionURL = "{% url 'lit_reviews:add_sub_extraction_api' id=literature_review_id appraisal_id=appraisal_id %}";
    const DeleteSubExtractionURL = "{% url 'lit_reviews:delete_sub_extraction_api' id=literature_review_id appraisal_id=appraisal_id %}";
    const AppraisalDataURL = "{% url 'lit_reviews:appraisal_detail_api' id=literature_review_id appraisal_id=appraisal_id %}";
    const AppraisalAIDataURL = "{% url 'lit_reviews:appraisal_ai_update_api' id=literature_review_id appraisal_id=appraisal_id %}";
    const AppraisalExtractionFieldUpdateURL = "{% url 'lit_reviews:appraisal_extraction_field_update_api' id=literature_review_id appraisal_id=appraisal_id field_id=0 %}";
    const PDFHighloghtingURL =
        "{% url 'lit_reviews:pdf-highlighting-api' id=literature_review_id %}";

</script>

<script type="application/javascript" src="{% static 'lit_reviews/vue/appraisal_detail.js' %}"> </script>
<script type="text/javascript">

// const forms = document.getElementsByClassName("generate-highlighted-form")
// for (let i=0; i<forms.length; i++){
//     forms[i].addEventListener("submit", function(event){
//         const btn = event.target.getElementsByClassName("submit-btn")[0];
//         btn.style.pointerEvent = "none";
//         btn.style.opacity = ".4";
//         btn.classList.remove("submit-btn");
//         btn.classList.add("submit-btn-nohover");
//         btn.disabled = true;
//     })
// };

$(document).ready(function(){
    // Function to handle smooth scrolling to sections
    function scrollToSection(elementId) {
        // Get the target element
        const targetElement = document.getElementById(elementId);

        // Calculate the offset of the target element relative to the top of the page
        const offsetTop = targetElement.offsetTop;

        // Get the height of the fixed navbar
        const navbarHeight = 90;

        // Scroll to the target element with adjusted offset
        window.scrollTo({
            top: offsetTop - navbarHeight,
            behavior: 'smooth'
        });
    }

    // Attach click event listeners to the links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1); // Remove the '#' from href
            scrollToSection(targetId);
        });
    });

});
</script>
{% endblock %}