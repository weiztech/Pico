{% extends 'base_lit_reviews.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% block 'head' %}
<link href="{% static 'css/theme/article_details.css' %}" rel="stylesheet" type="text/css" />
{% endblock %}
{% block 'help_section' %} 
    <a href="https://citemed-io.gitbook.io/citemed.io-documentation/abstract-reviewing/the-1st-pass-abstract-review-screen">
        <span>Need help with this page? <br/> Read the Wiki</span>
        <div>
        <img src="{% static 'images/icons/wiki-icon.svg' %}">
        </div>
    </a>
{% endblock %}

{% block 'body' %}
<form method="post" id="form" class="form-content">
    <div class="section-header">
        <h4> 
            {{ object.article.title }}
        </h4>
    </div> 

    <div class="horizantal-devider"> </div>

    <div class="helper">
        <strong>Article Related Search Term : </strong> {{object.search.db.name }} -
        <span id="search_term"></span>
        <span class="link c-pointer" id='view_more' style="display: none;">...(View More)</span>
        <span id='view_less' class="link c-pointer" style="display: none;">(Show Less)</span>
    </div>

    <div class="article-arbstract">
        {% autoescape off %}
            {% if object.processed_abstract %}
                {{object.processed_abstract }}
            {% else %}
                {{ object.article.abstract }}
            {% endif %} 
        {% endautoescape %}
    </div>
    
    <div class="info-card">
        {{ object.article.citation | safe }}
    </div>

    <div class="info-card">
        {% if object.article.full_text %}
            <a class="center-v" href="{{object.article.full_text.url}}" target="_blank">
                <div class="file-download-icon mr">
                    <svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g clip-path="url(#clip0_213_6862)">
                        <path d="M4.46877 19.25L2.74658 17.5312H4.46877V19.25ZM17.5313 19.25L19.2535 17.5312H17.5313V19.25Z" fill="#A3313A"/>
                        <path d="M17.5312 4.46876H14.7847V1.7222L17.5312 4.46876Z" fill="#B2B2B2"/>
                        <path d="M14.7812 1.71875H5.01531C4.87036 1.71875 4.73133 1.77633 4.62883 1.87883C4.52633 1.98133 4.46875 2.12036 4.46875 2.26531V19.7966C4.46875 19.9418 4.52622 20.0812 4.62862 20.1843C4.73103 20.2873 4.87004 20.3457 5.01531 20.3466H16.9847C17.0581 20.3461 17.1307 20.331 17.1981 20.3021C17.2656 20.2732 17.3266 20.2311 17.3776 20.1782C17.4285 20.1254 17.4683 20.0628 17.4947 19.9943C17.5211 19.9258 17.5335 19.8527 17.5312 19.7794V4.46875H14.7812V1.71875Z" fill="#F1F1F1"/>
                        <path d="M3.09375 11.3438H18.9062C18.9974 11.3438 19.0849 11.38 19.1493 11.4444C19.2138 11.5089 19.25 11.5963 19.25 11.6875V17.5312H2.75V11.6875C2.75 11.5963 2.78622 11.5089 2.85068 11.4444C2.91515 11.38 3.00258 11.3438 3.09375 11.3438Z" fill="#C84D52"/>
                        <path d="M8.13672 14.8259V15.8125H7.44922V13.0006H8.54922C8.82664 12.9811 9.10063 13.0712 9.31234 13.2516C9.40371 13.3401 9.47471 13.4474 9.52042 13.5662C9.56613 13.6849 9.58544 13.8121 9.57703 13.9391C9.57883 14.1013 9.53856 14.2611 9.46016 14.4031C9.37963 14.5421 9.26012 14.6545 9.11641 14.7263C8.94171 14.8096 8.74954 14.8497 8.55609 14.8431L8.13672 14.8259ZM8.89297 13.9219C8.89297 13.6744 8.75547 13.5506 8.48047 13.5506H8.13672V14.2828H8.48047C8.75547 14.2828 8.89297 14.1625 8.89297 13.9219ZM12.2686 15.125C12.151 15.337 11.9742 15.5102 11.7598 15.6234C11.5189 15.7475 11.2505 15.809 10.9795 15.8022H9.91734V13.0006H10.9795C11.2501 12.9935 11.5183 13.0537 11.7598 13.1759C11.9749 13.2867 12.152 13.459 12.2686 13.6709C12.3892 13.8958 12.4496 14.148 12.4439 14.4031C12.447 14.6547 12.3867 14.9029 12.2686 15.125ZM11.5364 14.9841C11.6787 14.8193 11.7569 14.6088 11.7569 14.3911C11.7569 14.1734 11.6787 13.9629 11.5364 13.7981C11.3658 13.6495 11.1435 13.5742 10.9177 13.5884H10.598V15.1938H10.9177C11.1421 15.2109 11.3642 15.1393 11.5364 14.9944V14.9841ZM14.6645 13.0006V13.5438H13.5095V14.1591H14.3998V14.6747H13.5095V15.8125H12.822V13.0006H14.6645Z" fill="white"/>
                        <path d="M11.3092 3.61967C11.3345 3.85793 11.3111 4.09886 11.2404 4.3278C10.9345 5.38311 9.91013 9.22967 9.1367 9.77624C8.03326 10.56 7.4592 9.66967 8.04701 9.03717C8.63482 8.40467 12.1823 7.56249 13.3133 7.56249C14.7845 7.56249 14.5954 8.8653 13.7601 8.78624C12.8183 8.69686 10.4636 7.09155 10.3226 4.03905C10.2608 2.9528 11.2026 2.74999 11.3092 3.61967Z" stroke="#C84D52" stroke-miterlimit="10"/>
                        </g>
                        <defs>
                        <clipPath id="clip0_213_6862">
                            <rect width="22" height="22" fill="white"/>
                        </clipPath>
                        </defs>
                    </svg>
                </div>
                Article Full Text Click To Preview
            </a>
        {% else %}
            No FullText found on PMC, You need to Purchase or Upload it.
        {% endif %}
    </div>

    {% if object.state == 'I' %}
    <div class="info-card">
        <a href="{{clinical_app_link}}" class="article-review-detail-link"> Clinical Appraisal Review </a>
    </div>
    {% endif %}

    <div>
        {{ form.notes | as_crispy_field }}
    </div>

    <div>
        {{ form.tags | as_crispy_field }}
        <div class="invalid-feedback"> {{ form.tags.errors }} </div>
    </div>

    <div>
        {% csrf_token %} 
        <div>
        {{ form.state | as_crispy_field }}
        {{ form.exclusion_reason | as_crispy_field }}
        </div>

        <div class="center-v mt-2">
            <button type="submit" class="primary-button mr-2 w-50" id="save">Save</button>
            <button type="submit" class="secondary-gray-button w-50" id="save-next-btn"> Save and Next </button>
        </div>
    </div>

</form>

<div class="form-content">
    <div class="section-header">
        <h4> 
            Article Historical Reviews
        </h4>
    </div> 
    
    <div class="horizantal-devider"> </div>

    <div>
        <table class="custom-table">
            <thead>
            <tr>
                <th style="width: 400px;">article</th>
                <th>Company</th>
                <th>Project Name/Device</th>
                <th>Feedback</th>
            </tr>
            </thead>
            <tbody>
            {% for review in articles_reviews %}
                <tr>
                    <td>{{review.article}}</td>
                    <td>{{review.search.literature_review.client}}</td>
                    <td>{{review.search.literature_review}}</td>
                    <td>
                        <a href="{{ review.get_absolute_url }}?back={{ request.path  }}" class="exclude-link" target="_blank">
                            {% if review.state == "U" %}
                                Unclassified
                            {% elif review.state == "I"%}
                                Included
                            {% elif review.state == "M"%}
                                Maybe
                            {% elif review.state == "E"%}
                                Excluded
                            {% elif review.state == "D"%}
                                Duplicate
                            {% endif %}
                        </a>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    document.getElementById("save-next-btn").addEventListener("click", function(e){
        e.target.disabled = true;
        const form = e.target.form
        var input = document.createElement("input");
        input.type = "hidden";
        input.name = "next";
        input.style.visibility = "hidden";
        form.appendChild(input);
        form.submit()
    });
</script>
<script src="{% static 'lit_reviews/js/retained_article_details.js' %}"> </script>
<script>
    showTerm("{{object.search.term}}".replace(/&quot;/g, '\"'));
</script>

<script type="text/javascript">
   const divExclusionReason = document.getElementById("div_id_exclusion_reason")
   const exclusionReason = document.getElementById("id_exclusion_reason")
   const form = document.getElementById("form")
   const alert = document.getElementById("alert")
   const state = document.getElementById('id_state')

   if(state.value != "E") divExclusionReason.style.display="none"
  
   state.addEventListener("change",function(e){
        if(e.target.value === "E") divExclusionReason.style.display=""
        else divExclusionReason.style.display="none"
   })

   form.addEventListener("submit",function(e){
        e.preventDefault()
        document.getElementById("save").disabled = true;
        form.submit()
   })

</script>

{% endblock %}